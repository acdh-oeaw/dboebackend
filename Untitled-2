select a.es_id, count(a.es_id) from annotations_es_document a group by a.es_id  
having count(a.es_id) >  1;


select a.es_id, b.es_document_id, b.collection_id from annotations_es_document a join annotations_collection_es_document b on a.id = b.es_document_id group by (a.es_id, b.es_document_id, b.collection_id)  
having count(a.es_id) >  1;



select a.es_id, b.es_document_id, b.collection_id from annotations_es_document a
    join annotations_collection_es_document b 
        on a.id = b.es_document_id 
    group by (a.es_id, b.es_document_id, b.collection_id)  
    having count(a.es_id) >  1;

select a.es_id, b.es_document_id, count(b.collection_id) from annotations_es_document a
    join annotations_collection_es_document b 
        on a.id = b.es_document_id
    where  a.es_id in (
        select a.es_id from annotations_es_document a group by a.es_id  
having count(a.es_id) >  1
    ) 
    group by (es_id, es_document_id);



select a.es_id, b.es_document_id, b.collection_id from annotations_es_document a
    join annotations_collection_es_document b 
        on a.id = b.es_document_id 
    group by (a.es_id, b.es_document_id, b.collection_id)  
    having count(a.es_id) >  1;

select a.es_id, b.es_document_id, count(b.collection_id) from annotations_es_document a
    join annotations_collection_es_document b 
        on a.id = b.es_document_id
    where  a.es_id in (
        select a.es_id from annotations_es_document a group by a.es_id  
having count(a.es_id) >  1
    ) 
    group by (es_id, es_document_id);



select es_id, id from annotations_es_document
    where es_id in (
        select a.es_id from annotations_es_document a group by a.es_id
having count(a.es_id) >  1);
    

select a.es_id, count(a.es_id) from annotations_es_document a group by a.es_id
having count(a.es_id) >  1;


#all ids of double es_id: 
select es_id, id from annotations_es_document
    where es_id in (
        select a.es_id from annotations_es_document a group by a.es_id
having count(a.es_id) >  1);


#all ids of double es_id without collections: 
select es_id, id from annotations_es_document
    where es_id in (
        select a.es_id from annotations_es_document a group by a.es_id
having count(a.es_id) >  1)
    AND 
    id not in(
        select es_document_id from annotations_collection_es_document 
    )
;
546


delete from annotations_es_document
    where es_id in (
        select a.es_id from annotations_es_document a group by a.es_id
having count(a.es_id) >  1)
    AND 
    id not in(
        select es_document_id from annotations_collection_es_document 
    )
;

delete from annotations_es_document
    where es_id in (
        select a.es_id from annotations_es_document a group by a.es_id
having count(a.es_id) >  1)
    AND 
    id not in(
        select es_document_id from annotations_collection_es_document 
    )
;



alter table annotations_es_document add constraint unique_es_id unique (es_id)